<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Candlestick Chart</title>
    <!-- å¼•å…¥ Chart.js å’Œé‡‘èå›¾è¡¨æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    <style>
        /* ç¾åŒ–ä¸‹æ‹‰æ¡†å’Œæ•´ä½“å¸ƒå±€ */
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #aaa;
        }

        select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        /* æ¨ªçº¿æ ·å¼ */
        #horizontal-line {
            position: absolute;
            display: none;
            border-top: 1px dashed #999;
            pointer-events: none;
        }

        /* ä»·æ ¼æ ‡ç­¾æ ·å¼ */
        #price-label {
            position: absolute;
            display: none;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>
<!-- ä¸‹æ‹‰é€‰æ‹©æ¡† -->
<div class="controls">
    <div class="control-group">
        <label for="symbol">Symbol:</label>
        <select id="symbol">
            <option value="BTCUSDT" selected>BTC/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
            <option value="SUIUSDT">SUI/USDT</option>
            <option value="EPTUSDT">EPT/USDT</option>
        </select>
    </div>

    <div class="control-group">
        <label for="interval">Interval:</label>
        <select id="interval">
            <option value="1m">1åˆ†é’Ÿ</option>
            <option value="5m" selected>5åˆ†é’Ÿ</option>
            <option value="15m">15åˆ†é’Ÿ</option>
            <option value="1h">1å°æ—¶</option>
            <option value="4h">4å°æ—¶</option>
            <option value="1d">1å¤©</option>
        </select>
    </div>

    <div class="control-group">
        <label for="limit">æ•°æ®é‡:</label>
        <select id="limit">
            <option value="30">30æ¡</option>
            <option value="50" selected>50æ¡</option>
            <option value="100">100æ¡</option>
        </select>
    </div>
</div>

<!-- å›¾è¡¨å®¹å™¨ -->
<div style="position: relative; width: 1920px; height: 1080px;">
    <canvas id="candlestickChart"></canvas>
    <div id="horizontal-line"></div>
    <div id="price-label"></div>
</div>

<script>
    let chart;

    function getChartParams() {
        return {
            symbol: document.getElementById("symbol").value || "BTCUSDT",
            interval: document.getElementById("interval").value || "5m",
            limit: document.getElementById("limit").value || "50"
        };
    }

    async function fetchCandlestickData(startTime = null, endTime = null) {
        const { symbol, interval, limit } = getChartParams();
        let url = `/api/candlesticks?symbol=${symbol}&interval=${interval}&limit=${limit}`;
        if (startTime) url += `&startTime=${startTime}`;
        if (endTime) url += `&endTime=${endTime}`;

        const response = await fetch(url);
        const data = await response.json();

        return data.map(candle => ({
            x: new Date(candle.time).getTime(),
            o: candle.open,
            h: candle.high,
            l: candle.low,
            c: candle.close,
            v: candle.volume,
            qv: candle.quoteAssetVolume,
            nt: candle.numberOfTrades,
            ch: candle.change,
            am: candle.amplitude
        })).sort((a, b) => a.x - b.x);
    }

    async function renderChart() {
        const ctx = document.getElementById('candlestickChart').getContext('2d');
        const candlestickData = await fetchCandlestickData();

        if (chart) {
            chart.data.datasets[0].data = candlestickData;
            chart.update();
            return;
        }

        chart = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: `${getChartParams().symbol}`,
                    data: candlestickData,
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    borderWidth: 1,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: getChartParams().interval === '1d' ? 'day' :
                                getChartParams().interval === '4h' ? 'hour' : 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'MM-dd HH:mm',
                                day: 'yyyy-MM-dd'
                            },
                            tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                            stepSize: 1
                        },
                        ticks: {
                            source: 'data',
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: { display: false },
                        offset: false,
                        bounds: 'data',
                        title: { display: true, text: 'Time' }
                    },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(4);
                            }
                        },
                        title: { display: true, text: 'Price' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                const data = context.raw;
                                return [
                                    `å¼€: ${data.o}`,
                                    `é«˜: ${data.h}`,
                                    `ä½: ${data.l}`,
                                    `æ”¶: ${data.c}`,
                                    `æˆäº¤é‡: ${data.v}`,
                                    `æˆäº¤é¢: ${data.qv}`,
                                    `æˆäº¤ç¬”æ•°: ${data.nt}`,
                                    `æ¶¨è·Œå¹…: ${parseFloat(data.ch) >= 0 ? 'ğŸŸ¢' : 'ğŸ”´'} ${data.ch}`,
                                    `éœ‡å¹…: ${data.am}`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }

    // åˆå§‹åŒ–å›¾è¡¨
    renderChart();

    // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', () => {
            renderChart();
        });
    });

    // è·å– DOM å…ƒç´ 
    const canvas = document.getElementById('candlestickChart');
    const horizontalLine = document.getElementById('horizontal-line');
    const priceLabel = document.getElementById('price-label');

    let chartArea = null;

    function getChartArea() {
        if (!chart) return null;
        const area = chart.chartArea;
        return {
            top: chart.scales.y.top,
            bottom: chart.scales.y.bottom,
            left: chart.scales.x.left,
            right: chart.scales.x.right
        };
    }

    function getYValueFromPixel(y) {
        const scaleY = chart.scales.y;
        return scaleY.getValueForPixel(y);
    }

    function updateCrosshair(x, y) {
        chartArea = getChartArea();
        if (!chartArea || y < chartArea.top || y > chartArea.bottom) {
            horizontalLine.style.display = 'none';
            priceLabel.style.display = 'none';
            return;
        }

        horizontalLine.style.top = `${y}px`;
        horizontalLine.style.left = `${chartArea.left}px`;
        horizontalLine.style.width = `${chartArea.right - chartArea.left}px`;
        horizontalLine.style.display = 'block';

        const price = getYValueFromPixel(y).toFixed(4);
        priceLabel.innerHTML = `ï¿¥${price}`;
        priceLabel.style.left = `${x + 10}px`;
        priceLabel.style.top = `${y - 20}px`;
        priceLabel.style.display = 'block';
        priceLabel.dataset.price = price;
    }

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        updateCrosshair(x, y);
    });

    canvas.addEventListener('mouseleave', () => {
        horizontalLine.style.display = 'none';
        priceLabel.style.display = 'none';
    });

    canvas.addEventListener('click', () => {
        if (priceLabel.style.display === 'none') return;

        const price = priceLabel.dataset.price;
        const symbol = document.getElementById("symbol").value;

        const confirmCreate = confirm(`æ‚¨ç‚¹å‡»çš„ä»·æ ¼ä¸ºï¼š${price}\næ˜¯å¦è®¾ç½®ä»·æ ¼æé†’ï¼Ÿ`);
        if (confirmCreate) {
            const threshold = prompt("è¯·è¾“å…¥æé†’é˜ˆå€¼:", price);

            if (threshold !== null && !isNaN(threshold)) {
                fetch(`/api/reminder/${symbol}?threshold=${threshold}`, {
                    method: 'GET'
                }).then(response => {
                    if (response.ok) {
                        alert("æé†’ä»»åŠ¡å·²æäº¤ï¼");
                    } else {
                        alert("æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚");
                });
            }
        }
    });
</script>
</body>
</html>
